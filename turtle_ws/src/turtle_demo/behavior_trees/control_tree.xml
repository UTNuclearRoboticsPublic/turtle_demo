<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <Sequence>
      <SetBlackboardNode value="100" output_key="turtle2_energy"/>
      <GetCurrentPose reference_frame="world" target_frame="turtle1" pose="{last_known_pose}"/>
      <GetCurrentPose reference_frame="world" target_frame="turtle1" pose="{center_pose}"/>
      <RetryNode num_attempts="-1">
        <Fallback name="Main Loop">
          <Sequence>
            <SubTree ID="Proximity Check"/>
            <TriggerService service_name="/target_seen"/>
            <ReactiveSequence name="Chase Nearby Target">
              <SubTree ID="Proximity Check"/>
              <GetCurrentPose reference_frame="world" target_frame="turtle1" pose="{last_known_pose}"/>
              <GetCurrentPose reference_frame="turtle2" target_frame="turtle1" pose="{relative_pose}"/>
              <ReactiveFallback>
                <SubTree ID="Move Turtle" velocity="{chase_velocity}" energy="{turtle2_energy}"/>
                <RechargeEnergy max_energy="100" energy_per_tick = "0.5" energy="{turtle2_energy}"/>
              </ReactiveFallback>
              <ChaseTarget relative_pose="{relative_pose}" chase_velocity="{chase_velocity}"/>
            </ReactiveSequence>
          </Sequence>
          <Sequence>
            <TriggerService service_name="/target_lost"/>
            <ReactiveSequence>
              <Inverter>
                <SubTree ID="Proximity Check"/>
              </Inverter>
              <GetCurrentPose reference_frame="world" target_frame="turtle2" pose="{chaser_pose}"/>
              <GetCurrentPose reference_frame="turtle2" target_frame="turtle1" pose="{relative_pose}"/>
              <RepeatNode num_cycles="-1">
                <Fallback name="Target Out of Range">
                  <Sequence>
                    <SubTree ID="Rest" energy="{turtle2_energy}"/>
                    <SubTree ID="Scan Search" chaser_pose="{chaser_pose}" relative_pose="{relative_pose}" last_known_pose="{last_known_pose}" center_pose="{center_pose}" energy="{turtle2_energy}"/>
                  </Sequence>
                  <Sequence>
                    <SubTree ID="Rest" energy="{turtle2_energy}"/>
                    <SubTree ID="Patrol Search" chaser_pose="{chaser_pose}" energy="{turtle2_energy}"/>
                  </Sequence>
                </Fallback>
              </RepeatNode>
            </ReactiveSequence>
          </Sequence>
        </Fallback>
      </RetryNode>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="Proximity Check">
    <Sequence>
      <GetCurrentPose reference_frame="turtle2" target_frame="turtle1" pose="{relative_pose}"/>
      <TargetWithinRange target_pose="{relative_pose}" range="2.0"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="Move Turtle">
    <!--
    Bidirectional ports: velocity, energy
    -->
    <Fallback>
      <Sequence>
        <ConsumeEnergy velocity="{velocity}" energy="{energy}"/>
        <ForceSuccessNode>
          <PublishMessageToTopic topic="/turtle2/cmd_vel" value="{velocity}"/>
        </ForceSuccessNode>
      </Sequence>
      <Sequence>
        <StopTurtle zero_velocity="{velocity}"/>
        <PublishMessageToTopic topic="/turtle2/cmd_vel" value="{velocity}"/>
        <AlwaysFailureNode/>
      </Sequence>
    </Fallback>
  </BehaviorTree>

  <BehaviorTree ID="Scan Search">
    <!--
    Input Ports: chaser_pose, relative_pose, 
    Bidirectional Ports: last_known_pose, energy
    -->
    <ReactiveSequence>
      <Inverter>
        <SubTree ID="Proximity Check"/>
      </Inverter>
      <SubTree ID="Move Turtle" velocity="{velocity}" energy="{energy}"/>
      <Sequence>
        <GoToPoint target_pose="{center_pose}" chaser_pose="{chaser_pose}" chase_velocity="{velocity}"/>
        <KeepRunningUntilFailure>
          <Sequence>
            <IfThenElse>
              <RelativeAnglePositive chaser_pose="{chaser_pose}" last_known_pose="{last_known_pose}"/>
              <ScanSearch relative_pose="{relative_pose}" chaser_pose="{chaser_pose}" rotation_speed="-1.0" scan_velocity="{velocity}"/>
              <ScanSearch relative_pose="{relative_pose}" chaser_pose="{chaser_pose}" rotation_speed="1.0" scan_velocity="{velocity}"/>
            </IfThenElse>
            <StopTurtle zero_velocity="{velocity}"/>
            <GetCurrentPose reference_frame="world" target_frame="turtle1" pose="{last_known_pose}"/>
            <GoToPoint target_pose="{last_known_pose}" chaser_pose="{chaser_pose}" chase_velocity="{velocity}"/>
            <StopTurtle zero_velocity="{velocity}"/>
          </Sequence>
        </KeepRunningUntilFailure>
      </Sequence>
    </ReactiveSequence>
  </BehaviorTree>

  <BehaviorTree ID="Patrol Search">
    <!--
    Input Port: chaser_pose
    Bidirectional Port: energy
    -->
    <ReactiveSequence>
      <Inverter>
        <SubTree ID="Proximity Check"/>
      </Inverter>
      <SubTree ID="Move Turtle" velocity="{velocity}" energy="{energy}"/>
      <Sequence>
        <FindCorner corner_pose="{corner_pose}" radius="2.0" chaser_pose="{chaser_pose}"/>
        <GoToPoint target_pose="{corner_pose}" chaser_pose="{chaser_pose}" chase_velocity="{velocity}"/>
        <StopTurtle zero_velocity="{velocity}"/>
        <PatrolSearch chaser_pose="{chaser_pose}" radius="2.0" chase_velocity="{velocity}"/>
      </Sequence>
    </ReactiveSequence>
  </BehaviorTree>

  <BehaviorTree ID="Rest">
    <!--
    Bidirectional Port: energy
    -->
    <Sequence>
      <Print message="Beginning rest"/>
      <StopTurtle zero_velocity="{velocity}"/>
      <SubTree ID="Move Turtle" velocity="{velocity}" energy="{energy}"/>
      <ReactiveSequence>
        <Print message="Rest reactive sequence"/>
        <Inverter>
          <SubTree ID="Proximity Check"/>
        </Inverter>
        <RechargeEnergy max_energy="100" energy_per_tick = "0.5" energy="{energy}"/>
      </ReactiveSequence>
      <Print message="Ending rest"/>
    </Sequence>
  </BehaviorTree>

</root>
